# Initial implementation of the Warnow model
# Input is an annual dataslice and frequency table/probs for references within
# Output is a dataframe/csv with refpairs and a table of k values.
# George Chacko 12/17/2018

# Clear workspace
rm(list = ls())
setwd("~/")
library(data.table)
library(dplyr)

# read data
d1980 <- fread("dataset1980_dec2018.csv")
# read frequency files
freqs <- fread("dataset1980_freqs.csv")

# select pubs with at least two references 
print(dim(d1980))
d1980[,refcount:=.N,by='source_id']
d1980 <- d1980[refcount>1]
print(dim(d1980))

# get rid of unnecessary columns
d1980 <- d1980[,c('source_id','cited_source_uid','reference_year')]

# break data up into chunks of source_id:cited_source_uid and insert into list
datalist <- list()
source_id_vec <- as.vector(unique(d1980$source_id)) #unique should not be necessary
for (i in 1:length(source_id_vec)) { 
	datalist[[i]] <- d1980[source_id == source_id_vec[i]]
		if(i%%5000 == 0) {
		print(paste('completed',i))
	}
}

# collapse list and write as csv
d1980table <- rbindlist(datalist)
write.csv(d1980table,file='d1980table.csv',row.names=FALSE)

# remove d1980 to save memory- it should help in theory at least
rm(d1980)

# looping through datalist create list of reference pairs for each pub
refpair_list <- list()
for (i in 1:length(datalist)) {
	x <- datalist[[i]]
	# print(length(x$cited_source_uid))
	y <- data.frame(t(combn(x$cited_source_uid, 2)),stringsAsFactors=FALSE)
	refpair_list[[i]] <- y
	names(refpair_list)[i] <- x[1,1]
}

# collapse list and reduce to unique reference pairs
refpairs_table <- rbindlist(refpair_list)
refpairs_table <- data.table(refpairs_table)
refpairs_table <- unique(refpairs_table)

# merge f,F, and P

x1 <- merge(refpairs_table,freqs,by.x='X1',by.y='cited_source_uid')
colnames(x1) <- c("X1", "X2", "X1_refyear", "X1_f", "X1_F", "X1_p")
x2 <- merge(refpairs_table,freqs,by.x='X2', by.y='cited_source_uid')
colnames(x2) <- c("X2", "X1", "X2_refyear", "X2_f", "X2_F", "X2_p")
pairs <- merge(x1, x2, by = c("X1", "X2"))
pairs <- data.table(pairs)
# write as csv
write.csv(pairs,file='pairs.csv',row.names=FALSE)


# calculate number of draws for each reference in a publication 
# for example if a pub has three references from 1975 then k=3 for 1975 refs.

# looping through datalist count k values for reference_years for each pub
ref_k_list <- list()
for (i in 1:length(datalist)) {
	x <- datalist[[i]]
	x <- data.table(x)
	y <- x[,.N,by=c('source_id','reference_year')]
	ref_k_list[[i]] <- y
	names(ref_k_list)[i] <- x[1,1]
}

# collapse and write to csv
k_table <- rbindlist(ref_k_list)
write.csv(k_table,file='k_table.csv',row.names=FALSE)